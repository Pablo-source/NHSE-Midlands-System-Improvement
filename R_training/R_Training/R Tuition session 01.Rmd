---
title: "R Training session.Rightcare Team"
author: "PLR pablo.leonrodenas@nhs.net"
date: "22/03/2022"
output: ioslides_presentation
incremental: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Session 1. Introduction {.smaller}

## Session content{.smaller}

- **1.Accessing the data**
  - This section will cover how to import data from Excel and CSV files into R,also how to connect to SQL databases  using ODBC and RDB packages. 
- **2.Summarizing data**
  - We will explore several Exploratory Data Analysis (EDA) methods to assess the analysis techniques we  can apply to our data
- **3.Exporting data**
  - Different ways of exporting the data into CSV and Excel
- **4.Data visualization using GGPLOT2**
  - Using GGPLOT2 package to build plots in R.  This is a framework in R designed to build graphics in layers, by adding different components to the plot once step at a time. The ggplot2 package allow users to improve the quality and aesthetics of the graphics we produce.
- **5.Markdown Language**
  - Markdown is a lightweight markup language that you can use to add formatting elements to plaintext text documents. 

## R Studio IDE{.columns-2}
<font size="4">We use RStudio as the premiered IDE to create analytical products in R. Advantages of this tool: 
- Combine console, file explorer, code editor and environment into a single window. 
- Debug code and profile shiny apps
- Create different workspaces for different projects
- Integrate code development with Git and Github for version control and team project work

This is an example of Rstudio
<https://www.rstudio.com/products/rstudio/>
</font> 

<font size="4">Panes:Source,Console,Environment,History..,<br>User can customize them)</font>
![R Studio](Figures/RStudio.PNG){width=250px}
![RPanes](Figures/R_studio_panes.JPG){width=250px}


## Getting help when coding in R
<font size="4">R is built around functions, so probably you will end up combining them to obtain your results. As in example below</font>
```{r Getting help in r, echo=TRUE}
Var <-c("Beds","Patients","Metric")
Num <-c(132,2300,'RAS')
Metricv <- round(c(20.04,126.13,86.47),digits=0)

Round <-cbind.data.frame(Var,Num,Metricv)
head(Round)
```

```{r}
# We use help() and ? functions to obtain information from any R command
help(round)
?(round)
```


## 1. Accessing the data I{.smaller}

In R you can access the data in different ways

**Crating a new data set**
- Entering manually: R allows you bind together vectors (defined by the concatenate c() function) in columns of rows to form a data.frame object.(As we saw in previous slide)

**Importing data from CSV**
- You can use two functions *read.csv()* or *read_csv()* from readr package included in the Tidyverse universe, to import CSV files into R.
The readr package makes it easy to get rectangular data out of comma separated (csv), tab separated (tsv) or fixed width files (fwf) and into R

```{r Read from internet, echo=TRUE}
# Using read.delim() function to input online texfile from URL:
online_data <- 
  read.delim("http://www.sthda.com/upload/boxplot_format.txt")
head(online_data)
```

## 1. Accessing the data II{.smaller}

**Importing data from csv**
```{r load tidiverse, include=FALSE}
library(tidyverse)
```

```{r Read csv file, echo=TRUE}
Car_speeds <-read_csv(file = 'Figures/car_speeds.csv')
head(Car_speeds)
```
## 1. Accessing the data III{.smaller}

**ODBC**
Open Database Connectivity (ODBC) is a protocol that you can use to connect a Microsoft Access database to an external data source such as Microsoft SQL Server

```{r Using ODBC connection, echo=TRUE}
library(DBI)
library(odbc)

con <- dbConnect(odbc::odbc()
                 , Driver="SQL Server"
                 , Server = "PRODNHSESQL101"
                 , Trusted_Connection="yes")


SQL_query <- dbGetQuery(con,                       
              "SELECT TOP (100) [Dataset]
              ,[WeekEnding]
              ,[Provider_Code],[CCG_Code],[Activity_Treatment_Function_Code],[Tci_Date]
              ,[Procedure_Priority_Code],[Proposed_Procedure_Opcs_Code]
              ,[AgeBand_at_WeekEnding]
              FROM [NHSE_PSDM_COVID19].[mpi].[WLMDS_Open_ASI_Combined]
")

head(SQL_query)
```

Year_completed	Ship	Length_m	Status 


**Importing data from Excel**

```{r test}
#library(readxl)
#library(writexl)
#wdata <- read_excel("Figures/shopping.xls", sheet = "Sheet1")
#wdata
```


## 2. Summarising data{.smaller}

We can use two main commands to summarize a dataset set of variables

**2.1. Visually by using the plot function**
```{r Visual data summary, fig.width=6, fig.heigh=8, echo=TRUE}
plot(mtcars)
```

## 2.2 Summarising data{.smaller}

**Providing a set of central tendency statistics**
Using the describe() function

We can include a set of basic descriptive statistics to help us understand different distributions present in our data

```{r Summary table, echo=TRUE}
summary(mtcars)
```

## **2.3 Desribe variables type and length**{.smaller}
```{r str function, echo=TRUE}
str(mtcars)
```

## **2.4 Obtain set of variable names from dataset**{.smaller}

```{r variable_names , echo=TRUE}
names(mtcars)
```

## **3. Exporting data**{.smaller}

In R you can export data as .csv file using this structure:   

**write.csv(Dataframe_name,"Path to export the DataFrame/File Name.csv", row.names = TRUE)**
```{r Create dataframe, echo=TRUE}
df <- data.frame(Name = c("Jon", "Bill", "Maria", "Tom", "Emma"),
                 Age = c(23,41,32,55,40)
                 )
print (df)
```

To export the above DataFrame to a csv file we use<br>

**write.csv(df,"Figures/exported_data.csv", row.names = TRUE)**


## 3. Exporting data (II) {.smaller}

Vanilla csv sport command
```{r Export_csv, echo=TRUE}
write.csv(df,"Figures/exported_data.csv", row.names = TRUE)
```
<br>
Sometimes we can improve the above code by including a time stamp in it: 
- using the paste0() function we can add current time with a custom format to the csv output file name

**write.csv(df,paste0("Figures/exported_data","_",format(Sys.time(),"%Y-%m-%d_%H:%M"),".csv"), row.names = TRUE)**

```{r Export_csv_timestamp, echo=TRUE}
write.csv(df,paste0("Figures/exported_data","_",format(Sys.time(),"%Y-%m-%d_%H:%M"),".csv"), row.names = TRUE)
```

## 4. Data visualization using ggplot2{.smaller}

**What is ggplot2?**

ggplot2 is a system for declaratively creating graphics, based on The Grammar of Graphics. You provide the data, tell ggplot2 how to map variables to aesthetics, what graphical primitives to use, and it takes care of the details

```{r ggplot2, echo=TRUE}
# The easiest way to get ggplot2 is to install the whole tidyverse:
#install.packages("tidyverse")
library(tidyverse)
# Alternatively, install just ggplot2:
# install.packages("ggplot2")
library(ggplot2)
# Or the development version from GitHub:
# install.packages("devtools")
#devtools::install_github("tidyverse/ggplot2")
```

Important resource to understand how the basic ggplot2 plots are built

<https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf>
<https://ggplot2.tidyverse.org/>

## 4. Data visualization using ggplot2(I){.smaller}

**USAGE**
Think about ggplot2 as building a visualization by layers: 

**1.** First we load the dataset we will plot using ggplot() function

**2.** Then we need to provide an aesthetic mapping aes() to include colour as a way of segmenting the plot

**3.** Finally we add a layer with the type of geometry we require (line, bar or dots chart)

**4.** On top of that we can apply faceting grouping different plots into a single image (small multiples)

**5.** And also we can specify coordinate systems coord_flig()

-(new layer to add more detail to the original plot)



## 4.1 Example of plotting with GGPLOT2{.smaller}

```{r First_ggplot,fig.width=8,fig.heigh=12,echo=TRUE}
library(ggplot2)

ggplot(mpg, aes(displ, hwy, colour = class)) + 
  geom_point()
```

We can combine line and dot charts on different layers

## 4.2 Combined geoms in ggplot2{.smaller}

We can combine lines and dots on the same graph
```{r Dotlineplot, echo=TRUE, fig.heigh=5, fig.width=8}
Var <-c("Patients","Patients","Patients")
Num <-c(132,2300,2100)
Dates <- as.Date(c("2007-06-21", "2007-06-22","2007-06-23"))

Mydata <-cbind.data.frame(Var,Num,Dates)
head(Mydata)
str(Mydata)
```

## 4.3 Combined output {.smaller}
```{r Line_chart_plot, echo=FALSE, fig.heigh=1, fig.width=8}
## plot it including lines and dots
library(ggplot2)
p <- ggplot(Mydata, aes(x=Dates, y=Num))
p <- p + geom_line()
p <- p + ggtitle("Combined line and dot chart")
p <- p + geom_point(color="blue",size = 1)
p
```

## 5. Markdown Language{.smaller}
Markdown is a lightweight markup language that you can use to add formatting elements to plaintext text documents. Created by John Gruber in 2004, Markdown is now one of the worldâ€™s most popular markup languages.
![R Markdown](Figures/RMarkdown.JPG){width=400px}

Markdown Guide
<https://www.markdownguide.org/getting-started/>
<https://github.com/rstudio/rmarkdown-book/issues/30>
<https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf>


## 6. Resources{.smaller} 

- How to import data from Excel into R studio. R programming for beginners
<https://www.youtube.com/watch?v=cnD1op2Oo3M>

- R Cheatsheets
<https://www.rstudio.com/resources/cheatsheets/>
<https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf>
